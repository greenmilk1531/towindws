<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아르마! 그만 유기해!!</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            --bg-color: #111111;
            --bg-gradient: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #111111 100%);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --text-main: #e2e8f0;
            --text-dim: rgba(226, 232, 240, 0.4);
            --accent: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
            --timer-bg: rgba(255, 255, 255, 0.05);
            --header-glass: rgba(255, 255, 255, 0.05);
        }

        body.light-mode {
            --bg-color: #ffffff;
            --bg-gradient: radial-gradient(circle at 50% 50%, #f8fafc 0%, #f1f5f9 100%);
            --glass-bg: rgba(255, 255, 255, 0.4);
            --text-main: #0f172a;
            --text-dim: rgba(15, 23, 42, 0.5);
            --accent: #334155;
            --border: rgba(0, 0, 0, 0.08);
            --timer-bg: rgba(0, 0, 0, 0.03);
            --header-glass: rgba(0, 0, 0, 0.02);
        }

        .radius_img_1 { border-radius: 50%; }
        
        body {
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Share Tech Mono', monospace;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 32px;
            position: relative;
            transition: all 0.3s ease;
        }

        .header-glass {
            background: var(--header-glass);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 12px 24px;
            border: 1px solid var(--border);
            display: inline-block;
        }

        .status-glow {
            text-shadow: 0 0 15px var(--accent);
        }

        .timer-text {
            letter-spacing: 0.1em;
            color: var(--text-main);
            font-variant-numeric: tabular-nums;
        }

        .image-container {
            position: relative;
            filter: drop-shadow(0 15px 25px rgba(0,0,0,0.15));
        }

        .accent-bar {
            height: 2px;
            width: 30px;
            background: var(--accent);
            margin: 8px auto 0;
            opacity: 0.5;
        }

        #state-label {
            transition: color 0.3s ease;
        }
    </style>
</head>
<body class="p-6">
    <div class="glass-panel w-full max-w-xl p-10 pt-16">

        <header class="text-center mb-12">
            <div class="header-glass">
                <h1 class="text-xs opacity-60 tracking-[0.6em] font-medium" style="color: var(--text-main)">ARMA MONITOR</h1>
                <div class="accent-bar"></div>
            </div>
        </header>

        <div class="flex flex-col items-center justify-center">
            <div class="image-container mb-12">
                <img src="arma.png" alt="Arma Asset" 
                     class="max-h-52 object-contain radius_img_1"
                     onerror="this.parentElement.innerHTML='<div class=\'w-40 h-40 flex items-center justify-center border border-current rounded-full opacity-10 text-[10px]\'>IMAGE PENDING</div>'">
            </div>
            
            <div class="text-center py-8 px-10 rounded-3xl border w-full" style="background: var(--timer-bg); border-color: var(--border);">
                <p id="state-label" class="text-[10px] opacity-30 mb-4 tracking-[0.3em]" style="color: var(--text-main)">ABANDONMENT ELAPSED</p>
                <div class="flex flex-col items-center">
                    <span class="text-xs opacity-40 mb-2" style="color: var(--text-main)">유기시간</span>
                    <span id="abandoned-timer" class="text-6xl font-bold timer-text status-glow">00:00:00</span>
                </div>
                <p id="last-action-info" class="text-[9px] mt-4 opacity-20 uppercase tracking-widest">Command by: System</p>
            </div>
        </div>

        <footer class="mt-14 flex justify-between items-center opacity-20 text-[10px]" style="color: var(--text-main)">
            <div class="flex gap-6 tracking-widest">
                <span>Copyright 2026. greenmilk All rights reserved.</span>
                <span id="status-indicator">STATUS: STABLE</span>
            </div>
            <div id="system-clock" class="font-bold tabular-nums">00:00:00</div>
        </footer>
    </div>

    <script>
        // 서버 연동 및 알림 변수
        let serverElapsedMs = 0;
        let isRunning = false;
        let localLastSyncTime = Date.now();
        let firstLoad = true;
        let lastStatus = null; // 이전 상태 저장용

        // 알림 권한 요청 함수
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("이 브라우저는 알림을 지원하지 않습니다.");
                return;
            }

            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("알림 설정 완료", { body: "이제 유기 중단 시 알림을 보내드립니다!" });
                    }
                });
            }
        }

        // 알림 보내기 함수
        function sendStatusNotification(username) {
            if (Notification.permission === "granted") {
                new Notification("유기 중단 알림", {
                    body: `${username}님이 안유기 처리를 하였습니다. 타이머가 일시정지되었습니다.`,
                    icon: "arma.png" // 아이콘 경로가 맞는지 확인 필요
                });
            }
        }

        // 서버에서 최신 상태 가져오기 (2초마다)
        async function syncWithServer() {
            try {
                const response = await fetch('https://uge.gmilk.kr/api/status');
                const data = await response.json();
                
                serverElapsedMs = data.totalElapsedMs;
                localLastSyncTime = Date.now();

                // 상태 변화 감지 (유기 -> 안유기)
                if (lastStatus === true && data.isRunning === false) {
                    sendStatusNotification(data.lastActionUser);
                }

                isRunning = data.isRunning;
                lastStatus = isRunning; // 현재 상태 저장

                // UI 상태 업데이트
                document.getElementById('last-action-info').innerText = `Last Command by: ${data.lastActionUser}`;
                document.getElementById('state-label').innerText = isRunning ? "RECORDING U GE" : " U GE PAUSED";
                document.getElementById('state-label').style.color = isRunning ? "var(--text-main)" : "#ef4444";
                document.getElementById('status-indicator').innerText = isRunning ? "STATUS: ACTIVE" : "STATUS: PAUSED";
                
                // 일시정지 상태일 때 효과 변경
                const timerEl = document.getElementById('abandoned-timer');
                if (!isRunning) {
                    timerEl.classList.remove('status-glow');
                    timerEl.style.opacity = "0.5";
                } else {
                    timerEl.classList.add('status-glow');
                    timerEl.style.opacity = "1";
                }

                if(firstLoad) {
                    firstLoad = false;
                    requestNotificationPermission();
                }

            } catch (error) {
                console.error("Sync Error:", error);
            }
        }

        // 화면 렌더링 (매 프레임/짧은 간격)
        function updateDisplay() {
            const now = Date.now();
            let currentDisplayTime = serverElapsedMs;

            if (isRunning) {
                currentDisplayTime += (now - localLastSyncTime);
            }

            const h = String(Math.floor(currentDisplayTime / 3600000)).padStart(2, '0');
            const m = String(Math.floor((currentDisplayTime % 3600000) / 60000)).padStart(2, '0');
            const s = String(Math.floor((currentDisplayTime % 60000) / 1000)).padStart(2, '0');
            document.getElementById('abandoned-timer').innerText = `${h}:${m}:${s}`;

            const date = new Date();
            const sysH = String(date.getHours()).padStart(2, '0');
            const sysM = String(date.getMinutes()).padStart(2, '0');
            const sysS = String(date.getSeconds()).padStart(2, '0');
            document.getElementById('system-clock').innerText = `${sysH}:${sysM}:${sysS}`;
        }

        // 초기화 및 루프 설정
        setInterval(updateDisplay, 100);
        setInterval(syncWithServer, 2000);
        
        // 페이지 클릭 시 알림 권한 요청 (브라우저 정책 대응)
        window.addEventListener('click', () => {
            if (Notification.permission === "default") {
                requestNotificationPermission();
            }
        }, { once: true });

        syncWithServer();
    </script>
</body>
</html>